% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/mjoint_Clayton.R
\name{mjoint_Clayton}
\alias{mjoint_Clayton}
\title{Fit a joint model with two correlated survival endpoints via Clayton copula}
\usage{
mjoint_Clayton(
  Mixeffect,
  Longdat,
  Surdat1,
  Surdat2,
  formSurv1,
  formSurv2,
  timevars1,
  timevars2,
  y_type = c("gaussian", "poisson"),
  rho0 = 0.5,
  nMC = 100,
  iter_max = 500,
  tol = 0.005,
  rho.region = c(1e-04, 30),
  eps_prob = 1e-100,
  verbose = FALSE
)
}
\arguments{
\item{Mixeffect}{Mixed-effects model formula for the longitudinal process,
e.g., \code{y ~ time + X1 + X2 + (1 | id)} or \code{y ~ time + X1 + X2 + (1 + time | id)}.}

\item{Longdat}{Longitudinal \code{data.frame} containing at least \code{id}, \code{time},
the response \code{y}, and covariates used in \code{Mixeffect}.}

\item{Surdat1}{Survival \code{data.frame} for endpoint 1. Must contain \code{id},
event time \code{surtime}, censoring indicator \code{cens}, baseline covariates in \code{formSurv1},
and any columns referenced by \code{timevars1}.}

\item{Surdat2}{Survival \code{data.frame} for endpoint 2 (same format as \code{Surdat1}).}

\item{formSurv1}{Cox formula for endpoint 1, e.g. \code{Surv(surtime, cens) ~ W}.}

\item{formSurv2}{Cox formula for endpoint 2.}

\item{timevars1}{Named list \code{list(fixed = FUN, rand = FUN)} for endpoint 1.
\code{fixed(t, index, Sur = ..., ...)} returns a matrix of time-varying covariates
entering the fixed part of the survival model (dimension \code{p1}).
\code{rand(t, index, ...)} returns the random-effect design used in the association
term (dimension matches the random-effect dimension in \code{Mixeffect}).}

\item{timevars2}{Named list \code{list(fixed = FUN, rand = FUN)} for endpoint 2.}

\item{y_type}{Character string specifying the longitudinal distribution:
\code{"gaussian"} or \code{"poisson"}.}

\item{rho0}{Initial value for the Clayton copula parameter \eqn{\rho > 0}.
Default is \code{0.5}.}

\item{nMC}{Initial Monte Carlo sample size used in the E-step.
The algorithm may adaptively increase it.}

\item{iter_max}{Maximum number of EM iterations.}

\item{tol}{Convergence tolerance for the EM algorithm.}

\item{rho.region}{Search interval for \eqn{\rho} used by \code{\link[stats]{optimize}}.}

\item{eps_prob}{Numerical guard used in likelihood evaluations to avoid \code{log(0)}
or division by zero.}

\item{verbose}{Logical; if \code{TRUE}, print progress information.}
}
\value{
An object of class \code{"mjoint_fit"} containing parameter estimates and
model components. Use \code{\link{summary.mjoint_fit}} to summarize.
}
\description{
Fits a joint model that links a longitudinal outcome with \strong{two correlated}
time-to-event endpoints via \strong{shared random effects}. Dependence between the
two event times is modeled by a \strong{Clayton survival copula}. Estimation is
performed via a Monte Carlo EM algorithm (MCEM).
}
\details{
The longitudinal submodel can be:
\itemize{
\item a Gaussian linear mixed model (LMM), or
\item a Poisson generalized linear mixed model (GLMM).
}

The two survival submodels are Cox-type models and can include
user-specified time-varying covariates via \code{timevars1} and \code{timevars2}.
}
\examples{
\dontrun{
## ------------------------------------------------------------
## Example datasets shipped with the package
## ------------------------------------------------------------
## Each dataset is a list called `blocks` with:
##   blocks$Longdat, blocks$Surdat1, blocks$Surdat2
##
## Available datasets:
##   Gaussian_Clayton_One
##   Poisson_Clayton_One
##   Gaussian_Clayton_Two
##   Poisson_Clayton_Two

## ------------------------------------------------------------
## Helper: build time-varying covariates (fixed) and Z_sur (rand)
## - fixed uses B1,B2,B3 columns in Surdat
## - rand depends on random-effect dimension:
##     re_dim=1 -> 1
##     re_dim=2 -> (1, t)
## ------------------------------------------------------------
make_timevars <- function(re_dim = 1) {
  stopifnot(re_dim \%in\% c(1, 2))

  fixed_fun <- function(t, index, Sur = NULL, ...) {
    if (is.null(Sur)) stop("fixed_fun: Sur is NULL (build_surv_block must pass Sur=).")
    B1 <- Sur$B1[index]; B2 <- Sur$B2[index]; B3 <- Sur$B3[index]
    z  <- B1 * (t <= B3) + B2 * (t > B3)
    matrix(z, ncol = 1)
  }

  rand_fun <- function(t, index, ...) {
    if (re_dim == 1) matrix(1, nrow = length(t), ncol = 1) else cbind(1, t)
  }

  list(fixed = fixed_fun, rand = rand_fun)
}

formSurv1 <- survival::Surv(surtime, cens) ~ W
formSurv2 <- survival::Surv(surtime, cens) ~ W

## ------------------------------------------------------------
## Case 1g: Gaussian longitudinal + 1D random effects
## ------------------------------------------------------------
data(Gaussian_Clayton_One)
Longdat  <- Gaussian_Clayton_One$Longdat
Surdat1  <- Gaussian_Clayton_One$Surdat1
Surdat2  <- Gaussian_Clayton_One$Surdat2

Mixeffect <- y ~ time + X1 + X2 + (1 | id)
timevars1 <- make_timevars(re_dim = 1)
timevars2 <- make_timevars(re_dim = 1)

set.seed(1)
fit_1g <- mjoint_Clayton(
  Mixeffect = Mixeffect,
  Longdat   = Longdat,
  Surdat1   = Surdat1,
  Surdat2   = Surdat2,
  formSurv1 = formSurv1,
  formSurv2 = formSurv2,
  timevars1 = timevars1,
  timevars2 = timevars2,
  y_type    = "gaussian",
  rho0      = 0.5,
  nMC       = 100,
  iter_max  = 200,
  tol       = 5e-3,
  rho.region = c(1e-4, 30),
  verbose   = TRUE
)
summary(fit_1g)

## ------------------------------------------------------------
## Case 1p: Poisson longitudinal + 1D random effects
## ------------------------------------------------------------
data(Poisson_Clayton_One)
Longdat  <- Poisson_Clayton_One$Longdat
Surdat1  <- Poisson_Clayton_One$Surdat1
Surdat2  <- Poisson_Clayton_One$Surdat2

Mixeffect <- y ~ time + X1 + X2 + (1 | id)
timevars1 <- make_timevars(re_dim = 1)
timevars2 <- make_timevars(re_dim = 1)

set.seed(1)
fit_1p <- mjoint_Clayton(
  Mixeffect = Mixeffect,
  Longdat   = Longdat,
  Surdat1   = Surdat1,
  Surdat2   = Surdat2,
  formSurv1 = formSurv1,
  formSurv2 = formSurv2,
  timevars1 = timevars1,
  timevars2 = timevars2,
  y_type    = "poisson",
  rho0      = 0.5,
  nMC       = 100,
  iter_max  = 200,
  tol       = 5e-3,
  rho.region = c(1e-4, 30),
  verbose   = TRUE
)
summary(fit_1p)

## ------------------------------------------------------------
## Case 2g: Gaussian longitudinal + 2D random effects
## ------------------------------------------------------------
data(Gaussian_Clayton_Two)
Longdat  <- Gaussian_Clayton_Two$Longdat
Surdat1  <- Gaussian_Clayton_Two$Surdat1
Surdat2  <- Gaussian_Clayton_Two$Surdat2

Mixeffect <- y ~ time + X1 + X2 + (1 + time | id)
timevars1 <- make_timevars(re_dim = 2)
timevars2 <- make_timevars(re_dim = 2)

set.seed(1)
fit_2g <- mjoint_Clayton(
  Mixeffect = Mixeffect,
  Longdat   = Longdat,
  Surdat1   = Surdat1,
  Surdat2   = Surdat2,
  formSurv1 = formSurv1,
  formSurv2 = formSurv2,
  timevars1 = timevars1,
  timevars2 = timevars2,
  y_type    = "gaussian",
  rho0      = 0.5,
  nMC       = 100,
  iter_max  = 200,
  tol       = 5e-3,
  rho.region = c(1e-4, 30),
  verbose   = TRUE
)
summary(fit_2g)

## ------------------------------------------------------------
## Case 2p: Poisson longitudinal + 2D random effects
## ------------------------------------------------------------
data(Poisson_Clayton_Two)
Longdat  <- Poisson_Clayton_Two$Longdat
Surdat1  <- Poisson_Clayton_Two$Surdat1
Surdat2  <- Poisson_Clayton_Two$Surdat2

Mixeffect <- y ~ time + X1 + X2 + (1 + time | id)
timevars1 <- make_timevars(re_dim = 2)
timevars2 <- make_timevars(re_dim = 2)

set.seed(1)
fit_2p <- mjoint_Clayton(
  Mixeffect = Mixeffect,
  Longdat   = Longdat,
  Surdat1   = Surdat1,
  Surdat2   = Surdat2,
  formSurv1 = formSurv1,
  formSurv2 = formSurv2,
  timevars1 = timevars1,
  timevars2 = timevars2,
  y_type    = "poisson",
  rho0      = 0.5,
  nMC       = 100,
  iter_max  = 200,
  tol       = 5e-3,
  rho.region = c(1e-4, 30),
  verbose   = TRUE
)
summary(fit_2p)
}

}
